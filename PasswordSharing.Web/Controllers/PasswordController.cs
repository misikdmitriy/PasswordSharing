using System.Threading.Tasks;
using MediatR;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.ModelBinding;
using PasswordSharing.Web.MediatorRequests;
using PasswordSharing.Web.Models;

namespace PasswordSharing.Web.Controllers
{
	/// <summary>
	/// Password Controller
	/// </summary>
	[Route("api/[controller]")]
	[ApiController]
	public class PasswordController : ControllerBase
	{
		private readonly IMediator _mediator;

		/// <summary>
		/// Constructor
		/// </summary>
		/// <param name="mediator">MediatoR</param>
		public PasswordController(IMediator mediator)
		{
			_mediator = mediator;
		}

		/// <summary>
		/// Generate link for password sharing
		/// </summary>
		/// <param name="inModel">Password model</param>
		/// <response code="200">Returns share link to password</response>
		/// <response code="400">One of passwords was too long</response>
		/// <response code="500">Internal Server Error</response>
		[HttpPost("", Name = "PasswordGenerator")]
		[ProducesResponseType(typeof(UrlModel), 200)]
		[ProducesResponseType(400)]
		[ProducesResponseType(500)]
		public async Task<IActionResult> Generate([FromBody, BindRequired]PasswordInModel inModel)
		{
			var request = new GeneratePasswordLinkRequest(inModel.Passwords, inModel.ExpiresIn);
			var result = await _mediator.Send(request);

			var url = Url.Link("GetPassword", new
			{
			    passwordGroupId = result.PasswordGroupId,
				key = result.Key,
				controller = "password"
			});

			return Ok(new UrlModel { Url = url });
		}

        /// <summary>
        /// Decode passwords generated by 'PasswordGenerator' API
        /// </summary>
        /// <param name="passwordGroupId">Password Group ID</param>
        /// <param name="key">Key provided by 'PasswordGenerator' API</param>
        /// <response code="200">Returns decoded password</response>
        /// <response code="400">Several reasons: link expired or incorrect URL used</response>
        /// <response code="500">Internal Server Error</response>
        [HttpGet("{passwordGroupId}", Name = "GetPassword")]
		[ProducesResponseType(typeof(PasswordOutModel), 200)]
		[ProducesResponseType(400)]
		[ProducesResponseType(500)]
		public async Task<IActionResult> Password([FromRoute, BindRequired]int passwordGroupId,
			[FromQuery, BindRequired]string key)
		{
			var request = new RetrievePasswordRequest(key, passwordGroupId);
			var result = await _mediator.Send(request);

			return Ok(new PasswordOutModel { Passwords = result });
		}
	}
}
